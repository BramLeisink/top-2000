<script lang="ts">
  import Button from "$lib/components/ui/button/button.svelte";

  type Song = {
    id: number;
    artist: string;
    title: string;
    positions: Record<string, number>;
  };

  type ChartConfig = {
    topN: number;
    rowHeight: number;
    colWidth: number;
    margins: { top: number; right: number; bottom: number; left: number };
    nodeRadius: number;
  };

  type Point = {
    year: number;
    rank: number;
    x: number;
    y: number;
    type: "start" | "end" | "continuous" | "gap-start" | "gap-end";
  };

  type Segment = {
    points: Point[];
    color: string;
    song: Song;
    isFinal: boolean;
    finalRank?: number;
  };

  const CONFIG: ChartConfig = {
    topN: 10,
    rowHeight: 60,
    colWidth: 120,
    margins: { top: 145, right: 220, bottom: 90, left: 90 },
    nodeRadius: 6,
  };

  const rawData: Song[] = [
    {
      id: 4317079,
      artist: "Danny Vera",
      title: "Roller Coaster",
      positions: {
        "2019": 4,
        "2020": 1,
        "2021": 2,
        "2022": 2,
        "2023": 2,
        "2024": 4,
        "2025": 5,
      },
    },
    {
      id: 1063,
      artist: "Queen",
      title: "Bohemian Rhapsody",
      positions: {
        "1999": 1,
        "2000": 1,
        "2001": 1,
        "2002": 1,
        "2003": 1,
        "2004": 1,
        "2005": 2,
        "2006": 1,
        "2007": 1,
        "2008": 1,
        "2009": 1,
        "2010": 2,
        "2011": 1,
        "2012": 1,
        "2013": 1,
        "2014": 2,
        "2015": 2,
        "2016": 1,
        "2017": 1,
        "2018": 1,
        "2019": 1,
        "2020": 2,
        "2021": 1,
        "2022": 1,
        "2023": 1,
        "2024": 1,
        "2025": 1,
      },
    },
    {
      id: 1060,
      artist: "Eagles",
      title: "Hotel California",
      positions: {
        "1999": 2,
        "2000": 4,
        "2001": 3,
        "2002": 3,
        "2003": 2,
        "2004": 2,
        "2005": 3,
        "2006": 3,
        "2007": 3,
        "2008": 2,
        "2009": 2,
        "2010": 1,
        "2011": 2,
        "2012": 2,
        "2013": 2,
        "2014": 1,
        "2015": 3,
        "2016": 2,
        "2017": 2,
        "2018": 2,
        "2019": 2,
        "2020": 3,
        "2021": 4,
        "2022": 3,
        "2023": 3,
        "2024": 3,
        "2025": 3,
      },
    },
    {
      id: 5553845,
      artist: "Di-rect",
      title: "Soldier On",
      positions: {
        "2020": 12,
        "2021": 14,
        "2022": 19,
        "2023": 18,
        "2024": 14,
        "2025": 20,
      },
    },
    {
      id: 1061,
      artist: "Led Zeppelin",
      title: "Stairway To Heaven",
      positions: {
        "1999": 4,
        "2000": 3,
        "2001": 4,
        "2002": 4,
        "2003": 4,
        "2004": 4,
        "2005": 5,
        "2006": 5,
        "2007": 5,
        "2008": 5,
        "2009": 4,
        "2010": 5,
        "2011": 5,
        "2012": 3,
        "2013": 3,
        "2014": 3,
        "2015": 5,
        "2016": 3,
        "2017": 3,
        "2018": 4,
        "2019": 5,
        "2020": 5,
        "2021": 7,
        "2022": 6,
        "2023": 6,
        "2024": 7,
        "2025": 7,
      },
    },
    {
      id: 309045,
      artist: "Deep Purple",
      title: "Child In Time (Albumversie)",
      positions: {
        "1999": 3,
        "2000": 2,
        "2001": 2,
        "2002": 2,
        "2003": 3,
        "2004": 3,
        "2005": 4,
        "2006": 4,
        "2007": 4,
        "2008": 4,
        "2009": 5,
        "2010": 4,
        "2011": 3,
        "2012": 4,
        "2013": 4,
        "2014": 4,
        "2015": 8,
        "2016": 5,
        "2017": 5,
        "2018": 6,
        "2019": 12,
        "2020": 15,
        "2021": 15,
        "2022": 16,
        "2023": 17,
        "2024": 19,
        "2025": 24,
      },
    },
    {
      id: 6461743,
      artist: "Miss Montreal",
      title: "Door De Wind",
      positions: {
        "2020": 29,
        "2021": 20,
        "2022": 38,
        "2023": 51,
        "2024": 61,
        "2025": 88,
      },
    },
    {
      id: 1638,
      artist: "Pink Floyd",
      title: "Wish You Were\nHere",
      positions: {
        "2000": 45,
        "2001": 25,
        "2002": 29,
        "2003": 20,
        "2004": 21,
        "2005": 16,
        "2006": 8,
        "2007": 14,
        "2008": 12,
        "2009": 9,
        "2010": 6,
        "2011": 7,
        "2012": 6,
        "2013": 6,
        "2014": 6,
        "2015": 9,
        "2016": 9,
        "2017": 7,
        "2018": 5,
        "2019": 10,
        "2020": 9,
        "2021": 13,
        "2022": 11,
        "2023": 11,
        "2024": 12,
        "2025": 10,
      },
    },
    {
      id: 2323716,
      artist: "Racoon",
      title: "Oceaan",
      positions: {
        "2013": 33,
        "2014": 21,
        "2015": 21,
        "2016": 24,
        "2017": 24,
        "2018": 28,
        "2019": 34,
        "2020": 22,
        "2021": 27,
        "2022": 33,
        "2023": 31,
        "2024": 21,
        "2025": 18,
      },
    },
    {
      id: 84547,
      artist: "Guns N' Roses",
      title: "November Rain",
      positions: {
        "2000": 10,
        "2001": 18,
        "2002": 17,
        "2003": 6,
        "2004": 7,
        "2005": 10,
        "2006": 13,
        "2007": 20,
        "2008": 9,
        "2009": 16,
        "2010": 17,
        "2011": 17,
        "2012": 12,
        "2013": 13,
        "2014": 10,
        "2015": 13,
        "2016": 17,
        "2017": 10,
        "2018": 11,
        "2019": 14,
        "2020": 16,
        "2021": 17,
        "2022": 12,
        "2023": 15,
        "2024": 17,
        "2025": 16,
      },
    },
    {
      id: 128415,
      artist: "Dire Straits",
      title: "Brothers In Arms (Albumversie)",
      positions: {
        "1999": 28,
        "2000": 22,
        "2001": 7,
        "2002": 9,
        "2003": 11,
        "2004": 15,
        "2005": 19,
        "2006": 20,
        "2007": 19,
        "2008": 13,
        "2009": 21,
        "2010": 19,
        "2011": 15,
        "2012": 11,
        "2013": 11,
        "2014": 14,
        "2015": 15,
        "2016": 19,
        "2017": 17,
        "2018": 15,
        "2019": 17,
        "2020": 18,
        "2021": 18,
        "2022": 14,
        "2023": 12,
        "2024": 18,
        "2025": 12,
      },
    },
    {
      id: 49192,
      artist: "Coldplay",
      title: "Viva La Vida",
      positions: {
        "2009": 11,
        "2010": 7,
        "2011": 9,
        "2012": 16,
        "2013": 15,
        "2014": 23,
        "2015": 28,
        "2016": 33,
        "2017": 31,
        "2018": 36,
        "2019": 36,
        "2020": 43,
        "2021": 43,
        "2022": 31,
        "2023": 22,
        "2024": 26,
        "2025": 43,
      },
    },
    {
      id: 133583,
      artist: "Meat Loaf",
      title: "Paradise By The\nDashboard Light (Albumversie)",
      positions: {
        "1999": 5,
        "2000": 5,
        "2001": 5,
        "2002": 5,
        "2003": 5,
        "2004": 6,
        "2005": 6,
        "2006": 7,
        "2007": 10,
        "2008": 6,
        "2009": 12,
        "2010": 9,
        "2011": 11,
        "2012": 19,
        "2013": 22,
        "2014": 17,
        "2015": 30,
        "2016": 27,
        "2017": 27,
        "2018": 29,
        "2019": 35,
        "2020": 34,
        "2021": 35,
        "2022": 24,
        "2023": 29,
        "2024": 36,
        "2025": 49,
      },
    },
    {
      id: 7030385,
      artist: "Dermot Kennedy",
      title: "Better Days",
      positions: {
        "2024": 6,
        "2025": 509,
      },
    },
    {
      id: 71430,
      artist: "Golden Earring",
      title: "Radar Love (Albumversie)",
      positions: {
        "1999": 23,
        "2000": 21,
        "2001": 21,
        "2002": 27,
        "2003": 27,
        "2004": 12,
        "2005": 13,
        "2006": 16,
        "2007": 23,
        "2008": 17,
        "2009": 24,
        "2010": 16,
        "2011": 18,
        "2012": 18,
        "2013": 24,
        "2014": 26,
        "2015": 31,
        "2016": 22,
        "2017": 21,
        "2018": 27,
        "2019": 23,
        "2020": 33,
        "2021": 6,
        "2022": 15,
        "2023": 13,
        "2024": 20,
        "2025": 9,
      },
    },
    {
      id: 1394,
      artist: "Pink Floyd",
      title: "Shine On You\nCrazy Diamond",
      positions: {
        "2000": 50,
        "2001": 47,
        "2002": 33,
        "2003": 26,
        "2004": 25,
        "2005": 12,
        "2006": 14,
        "2007": 21,
        "2008": 19,
        "2009": 13,
        "2010": 15,
        "2011": 16,
        "2012": 7,
        "2013": 10,
        "2014": 9,
        "2015": 14,
        "2016": 20,
        "2017": 22,
        "2018": 18,
        "2019": 22,
        "2020": 28,
        "2021": 29,
        "2022": 27,
        "2023": 25,
        "2024": 25,
        "2025": 25,
      },
    },
    {
      id: 129202,
      artist: "Dire Straits",
      title: "Sultans Of Swing",
      positions: {
        "1999": 20,
        "2000": 16,
        "2001": 10,
        "2002": 16,
        "2003": 15,
        "2004": 27,
        "2005": 28,
        "2006": 27,
        "2007": 28,
        "2008": 23,
        "2009": 32,
        "2010": 25,
        "2011": 30,
        "2012": 28,
        "2013": 21,
        "2014": 27,
        "2015": 25,
        "2016": 26,
        "2017": 26,
        "2018": 20,
        "2019": 26,
        "2020": 27,
        "2021": 25,
        "2022": 20,
        "2023": 20,
        "2024": 16,
        "2025": 13,
      },
    },
    {
      id: 95334,
      artist: "Bruce Springsteen",
      title: "The River",
      positions: {
        "1999": 48,
        "2000": 33,
        "2001": 26,
        "2002": 19,
        "2003": 30,
        "2004": 20,
        "2005": 27,
        "2006": 40,
        "2007": 11,
        "2008": 21,
        "2009": 30,
        "2010": 30,
        "2011": 10,
        "2012": 15,
        "2013": 7,
        "2014": 16,
        "2015": 17,
        "2016": 14,
        "2017": 19,
        "2018": 21,
        "2019": 19,
        "2020": 21,
        "2021": 16,
        "2022": 23,
        "2023": 23,
        "2024": 37,
        "2025": 37,
      },
    },
    {
      id: 63416,
      artist: "John Lennon",
      title: "Imagine",
      positions: {
        "1999": 7,
        "2000": 7,
        "2001": 11,
        "2002": 11,
        "2003": 13,
        "2004": 9,
        "2005": 15,
        "2006": 15,
        "2007": 41,
        "2008": 15,
        "2009": 41,
        "2010": 26,
        "2011": 28,
        "2012": 22,
        "2013": 23,
        "2014": 38,
        "2015": 1,
        "2016": 12,
        "2017": 16,
        "2018": 16,
        "2019": 29,
        "2020": 26,
        "2021": 34,
        "2022": 52,
        "2023": 33,
        "2024": 46,
        "2025": 54,
      },
    },
    {
      id: 2282530,
      artist: "Disturbed",
      title: "The Sound Of Silence",
      positions: {
        "2016": 518,
        "2017": 54,
        "2018": 39,
        "2019": 18,
        "2020": 20,
        "2021": 19,
        "2022": 18,
        "2023": 16,
        "2024": 13,
        "2025": 22,
      },
    },
    {
      id: 1751461,
      artist: "Boudewijn de Groot",
      title: "Avond",
      positions: {
        "1999": 428,
        "2000": 121,
        "2001": 41,
        "2002": 25,
        "2003": 8,
        "2004": 5,
        "2005": 1,
        "2006": 2,
        "2007": 2,
        "2008": 3,
        "2009": 3,
        "2010": 3,
        "2011": 4,
        "2012": 5,
        "2013": 5,
        "2014": 5,
        "2015": 7,
        "2016": 6,
        "2017": 9,
        "2018": 10,
        "2019": 6,
        "2020": 7,
        "2021": 10,
        "2022": 8,
        "2023": 8,
        "2024": 8,
        "2025": 8,
      },
    },
    {
      id: 85072,
      artist: "Johnny Cash",
      title: "Hurt",
      positions: {
        "2009": 168,
        "2010": 118,
        "2011": 43,
        "2012": 29,
        "2013": 17,
        "2014": 29,
        "2015": 26,
        "2016": 28,
        "2017": 20,
        "2018": 22,
        "2019": 31,
        "2020": 40,
        "2021": 41,
        "2022": 47,
        "2023": 54,
        "2024": 60,
        "2025": 74,
      },
    },
    {
      id: 85255,
      artist: "Billy Joel",
      title: "Piano Man",
      positions: {
        "1999": 121,
        "2000": 83,
        "2001": 57,
        "2002": 58,
        "2003": 60,
        "2004": 66,
        "2005": 49,
        "2006": 54,
        "2007": 34,
        "2008": 50,
        "2009": 45,
        "2010": 45,
        "2011": 29,
        "2012": 36,
        "2013": 18,
        "2014": 7,
        "2015": 6,
        "2016": 4,
        "2017": 4,
        "2018": 3,
        "2019": 3,
        "2020": 4,
        "2021": 5,
        "2022": 4,
        "2023": 4,
        "2024": 5,
        "2025": 2,
      },
    },
    {
      id: 279551,
      artist: "The Alan Parsons\nProject",
      title: "Old And Wise",
      positions: {
        "1999": 24,
        "2000": 28,
        "2001": 13,
        "2002": 8,
        "2003": 9,
        "2004": 11,
        "2005": 9,
        "2006": 11,
        "2007": 9,
        "2008": 8,
        "2009": 18,
        "2010": 10,
        "2011": 20,
        "2012": 21,
        "2013": 31,
        "2014": 28,
        "2015": 37,
        "2016": 37,
        "2017": 35,
        "2018": 65,
        "2019": 76,
        "2020": 84,
        "2021": 80,
        "2022": 87,
        "2023": 85,
        "2024": 76,
        "2025": 85,
      },
    },
    {
      id: 86916,
      artist: "Metallica",
      title: "One (Albumversie)",
      positions: {
        "2003": 478,
        "2004": 23,
        "2005": 40,
        "2006": 30,
        "2007": 13,
        "2008": 35,
        "2009": 31,
        "2010": 34,
        "2011": 32,
        "2012": 20,
        "2013": 14,
        "2014": 18,
        "2015": 20,
        "2016": 25,
        "2017": 23,
        "2018": 23,
        "2019": 21,
        "2020": 30,
        "2021": 26,
        "2022": 22,
        "2023": 26,
        "2024": 27,
        "2025": 32,
      },
    },
    {
      id: 307015,
      artist: "Supertramp",
      title: "School",
      positions: {
        "1999": 26,
        "2000": 17,
        "2001": 16,
        "2002": 14,
        "2003": 21,
        "2004": 34,
        "2005": 37,
        "2006": 36,
        "2007": 52,
        "2008": 33,
        "2009": 46,
        "2010": 44,
        "2011": 37,
        "2012": 35,
        "2013": 37,
        "2014": 41,
        "2015": 52,
        "2016": 48,
        "2017": 44,
        "2018": 44,
        "2019": 41,
        "2020": 45,
        "2021": 47,
        "2022": 50,
        "2023": 57,
        "2024": 59,
        "2025": 73,
      },
    },
    {
      id: 105876,
      artist: "Toto",
      title: "Africa (Albumversie)",
      positions: {
        "1999": 34,
        "2000": 49,
        "2001": 33,
        "2002": 39,
        "2003": 52,
        "2004": 63,
        "2005": 70,
        "2006": 75,
        "2007": 110,
        "2008": 66,
        "2009": 100,
        "2010": 97,
        "2011": 87,
        "2012": 62,
        "2013": 28,
        "2014": 51,
        "2015": 42,
        "2016": 30,
        "2017": 25,
        "2018": 8,
        "2019": 11,
        "2020": 14,
        "2021": 23,
        "2022": 17,
        "2023": 21,
        "2024": 24,
        "2025": 23,
      },
    },
    {
      id: 3127,
      artist: "The Doors",
      title: "Riders On The\nStorm",
      positions: {
        "1999": 12,
        "2000": 14,
        "2001": 12,
        "2002": 10,
        "2003": 12,
        "2004": 16,
        "2005": 24,
        "2006": 26,
        "2007": 33,
        "2008": 22,
        "2009": 26,
        "2010": 27,
        "2011": 23,
        "2012": 32,
        "2013": 30,
        "2014": 40,
        "2015": 49,
        "2016": 46,
        "2017": 49,
        "2018": 58,
        "2019": 75,
        "2020": 81,
        "2021": 87,
        "2022": 102,
        "2023": 103,
        "2024": 117,
        "2025": 144,
      },
    },
    {
      id: 79652,
      artist: "Simon & Garfunkel",
      title: "Bridge Over\nTroubled Water",
      positions: {
        "1999": 9,
        "2000": 27,
        "2001": 17,
        "2002": 32,
        "2003": 32,
        "2004": 45,
        "2005": 42,
        "2006": 43,
        "2007": 66,
        "2008": 43,
        "2009": 39,
        "2010": 32,
        "2011": 33,
        "2012": 38,
        "2013": 38,
        "2014": 48,
        "2015": 59,
        "2016": 52,
        "2017": 58,
        "2018": 61,
        "2019": 82,
        "2020": 48,
        "2021": 55,
        "2022": 72,
        "2023": 78,
        "2024": 90,
        "2025": 100,
      },
    },
    {
      id: 140056,
      artist: "The Rolling Stones",
      title: "Angie",
      positions: {
        "1999": 8,
        "2000": 9,
        "2001": 22,
        "2002": 12,
        "2003": 10,
        "2004": 13,
        "2005": 18,
        "2006": 21,
        "2007": 45,
        "2008": 20,
        "2009": 36,
        "2010": 35,
        "2011": 41,
        "2012": 26,
        "2013": 46,
        "2014": 54,
        "2015": 77,
        "2016": 78,
        "2017": 70,
        "2018": 79,
        "2019": 90,
        "2020": 79,
        "2021": 91,
        "2022": 120,
        "2023": 119,
        "2024": 86,
        "2025": 102,
      },
    },
    {
      id: 137918,
      artist: "U2",
      title: "Sunday Bloody Sunday",
      positions: {
        "1999": 18,
        "2000": 13,
        "2001": 31,
        "2002": 24,
        "2003": 37,
        "2004": 29,
        "2005": 39,
        "2006": 41,
        "2007": 65,
        "2008": 41,
        "2009": 57,
        "2010": 55,
        "2011": 66,
        "2012": 55,
        "2013": 62,
        "2014": 62,
        "2015": 57,
        "2016": 49,
        "2017": 47,
        "2018": 69,
        "2019": 61,
        "2020": 52,
        "2021": 61,
        "2022": 75,
        "2023": 69,
        "2024": 64,
        "2025": 117,
      },
    },
    {
      id: 59472,
      artist: "The Rolling Stones",
      title: "Sympathy For The Devil (Albumversie)",
      positions: {
        "1999": 29,
        "2000": 34,
        "2001": 44,
        "2002": 28,
        "2003": 14,
        "2004": 26,
        "2005": 38,
        "2006": 45,
        "2007": 59,
        "2008": 38,
        "2009": 43,
        "2010": 43,
        "2011": 46,
        "2012": 50,
        "2013": 35,
        "2014": 37,
        "2015": 46,
        "2016": 60,
        "2017": 51,
        "2018": 49,
        "2019": 65,
        "2020": 66,
        "2021": 63,
        "2022": 78,
        "2023": 79,
        "2024": 110,
        "2025": 146,
      },
    },
    {
      id: 108832,
      artist: "Metallica",
      title: "Nothing Else\nMatters (Albumversie)",
      positions: {
        "2001": 1014,
        "2002": 99,
        "2003": 16,
        "2004": 19,
        "2005": 20,
        "2006": 10,
        "2007": 15,
        "2008": 14,
        "2009": 19,
        "2010": 11,
        "2011": 14,
        "2012": 14,
        "2013": 9,
        "2014": 11,
        "2015": 16,
        "2016": 15,
        "2017": 15,
        "2018": 13,
        "2019": 15,
        "2020": 17,
        "2021": 8,
        "2022": 9,
        "2023": 9,
        "2024": 11,
        "2025": 11,
      },
    },
    {
      id: 97700,
      artist: "Pearl Jam",
      title: "Black",
      positions: {
        "2009": 803,
        "2010": 452,
        "2011": 40,
        "2012": 24,
        "2013": 16,
        "2014": 12,
        "2015": 12,
        "2016": 10,
        "2017": 6,
        "2018": 7,
        "2019": 7,
        "2020": 6,
        "2021": 9,
        "2022": 7,
        "2023": 7,
        "2024": 10,
        "2025": 6,
      },
    },
    {
      id: 307456,
      artist: "AC/DC",
      title: "Whole Lotta Rosie",
      positions: {
        "1999": 53,
        "2000": 29,
        "2001": 15,
        "2002": 13,
        "2003": 19,
        "2004": 17,
        "2005": 21,
        "2006": 33,
        "2007": 12,
        "2008": 18,
        "2009": 17,
        "2010": 28,
        "2011": 34,
        "2012": 45,
        "2013": 64,
        "2014": 43,
        "2015": 53,
        "2016": 73,
        "2017": 59,
        "2018": 73,
        "2019": 81,
        "2020": 91,
        "2021": 107,
        "2022": 100,
        "2023": 112,
        "2024": 118,
        "2025": 124,
      },
    },
    {
      id: 82381,
      artist: "The Beatles",
      title: "Hey Jude",
      positions: {
        "1999": 11,
        "2000": 6,
        "2001": 9,
        "2002": 15,
        "2003": 18,
        "2004": 18,
        "2005": 14,
        "2006": 22,
        "2007": 18,
        "2008": 16,
        "2009": 23,
        "2010": 24,
        "2011": 24,
        "2012": 33,
        "2013": 45,
        "2014": 58,
        "2015": 48,
        "2016": 39,
        "2017": 61,
        "2018": 70,
        "2019": 72,
        "2020": 92,
        "2021": 106,
        "2022": 130,
        "2023": 136,
        "2024": 134,
        "2025": 232,
      },
    },
    {
      id: 129431,
      artist: "Dire Straits",
      title: "Private\nInvestigations (Albumversie)",
      positions: {
        "1999": 57,
        "2000": 19,
        "2001": 14,
        "2002": 7,
        "2003": 17,
        "2004": 24,
        "2005": 29,
        "2006": 31,
        "2007": 35,
        "2008": 25,
        "2009": 37,
        "2010": 36,
        "2011": 47,
        "2012": 49,
        "2013": 66,
        "2014": 70,
        "2015": 67,
        "2016": 67,
        "2017": 69,
        "2018": 80,
        "2019": 87,
        "2020": 95,
        "2021": 93,
        "2022": 99,
        "2023": 97,
        "2024": 75,
        "2025": 104,
      },
    },
    {
      id: 9438524,
      artist: "Pink Floyd",
      title: "Another Brick In The Wall",
      positions: {
        "1999": 17,
        "2000": 20,
        "2001": 20,
        "2002": 26,
        "2003": 39,
        "2004": 32,
        "2005": 52,
        "2006": 46,
        "2007": 86,
        "2008": 45,
        "2009": 56,
        "2010": 47,
        "2011": 53,
        "2012": 39,
        "2013": 48,
        "2014": 56,
        "2015": 72,
        "2016": 66,
        "2017": 90,
        "2018": 54,
        "2019": 69,
        "2020": 77,
        "2021": 73,
        "2022": 80,
        "2023": 89,
        "2024": 95,
        "2025": 118,
      },
    },
    {
      id: 308937,
      artist: "Queen",
      title: "Love Of My Life",
      positions: {
        "2000": 82,
        "2001": 108,
        "2002": 97,
        "2003": 111,
        "2004": 115,
        "2005": 78,
        "2006": 69,
        "2007": 82,
        "2008": 82,
        "2009": 73,
        "2010": 78,
        "2011": 75,
        "2012": 76,
        "2013": 82,
        "2014": 69,
        "2015": 74,
        "2016": 64,
        "2017": 72,
        "2018": 12,
        "2019": 13,
        "2020": 11,
        "2021": 12,
        "2022": 10,
        "2023": 10,
        "2024": 9,
        "2025": 14,
      },
    },
    {
      id: 51294,
      artist: "Adele",
      title: "Someone Like You",
      positions: {
        "2011": 6,
        "2012": 8,
        "2013": 25,
        "2014": 35,
        "2015": 18,
        "2016": 47,
        "2017": 89,
        "2018": 97,
        "2019": 126,
        "2020": 147,
        "2021": 124,
        "2022": 209,
        "2023": 185,
        "2024": 175,
        "2025": 289,
      },
    },
    {
      id: 87427,
      artist: "The Animals",
      title: "The House Of\nThe Rising Sun",
      positions: {
        "1999": 13,
        "2000": 12,
        "2001": 6,
        "2002": 6,
        "2003": 7,
        "2004": 8,
        "2005": 8,
        "2006": 12,
        "2007": 7,
        "2008": 7,
        "2009": 29,
        "2010": 18,
        "2011": 25,
        "2012": 51,
        "2013": 55,
        "2014": 78,
        "2015": 84,
        "2016": 71,
        "2017": 77,
        "2018": 86,
        "2019": 103,
        "2020": 124,
        "2021": 122,
        "2022": 138,
        "2023": 152,
        "2024": 147,
        "2025": 166,
      },
    },
    {
      id: 118789,
      artist: "Dire Straits",
      title: "Telegraph Road (Albumversie)",
      positions: {
        "2006": 329,
        "2007": 85,
        "2008": 371,
        "2009": 81,
        "2010": 73,
        "2011": 97,
        "2012": 73,
        "2013": 52,
        "2014": 52,
        "2015": 43,
        "2016": 53,
        "2017": 53,
        "2018": 40,
        "2019": 40,
        "2020": 42,
        "2021": 36,
        "2022": 30,
        "2023": 27,
        "2024": 23,
        "2025": 19,
      },
    },
    {
      id: 76559,
      artist: "The Beach Boys",
      title: "God Only Knows",
      positions: {
        "1999": 123,
        "2000": 117,
        "2001": 137,
        "2002": 110,
        "2003": 117,
        "2004": 88,
        "2005": 80,
        "2006": 68,
        "2007": 42,
        "2008": 59,
        "2009": 20,
        "2010": 20,
        "2011": 31,
        "2012": 44,
        "2013": 59,
        "2014": 13,
        "2015": 19,
        "2016": 18,
        "2017": 29,
        "2018": 46,
        "2019": 59,
        "2020": 63,
        "2021": 62,
        "2022": 70,
        "2023": 60,
        "2024": 53,
        "2025": 17,
      },
    },
    {
      id: 1189439,
      artist: "Ramses Shaffy\n& Liesbeth List",
      title: "Pastorale",
      positions: {
        "1999": 80,
        "2000": 119,
        "2001": 58,
        "2002": 40,
        "2003": 51,
        "2004": 43,
        "2005": 33,
        "2006": 24,
        "2007": 51,
        "2008": 40,
        "2009": 6,
        "2010": 21,
        "2011": 27,
        "2012": 46,
        "2013": 42,
        "2014": 47,
        "2015": 71,
        "2016": 69,
        "2017": 86,
        "2018": 106,
        "2019": 73,
        "2020": 73,
        "2021": 60,
        "2022": 91,
        "2023": 96,
        "2024": 94,
        "2025": 114,
      },
    },
    {
      id: 395791,
      artist: "ABBA",
      title: "Dancing Queen",
      positions: {
        "1999": 16,
        "2000": 30,
        "2001": 28,
        "2002": 41,
        "2003": 46,
        "2004": 42,
        "2005": 36,
        "2006": 49,
        "2007": 29,
        "2008": 37,
        "2009": 70,
        "2010": 68,
        "2011": 88,
        "2012": 111,
        "2013": 160,
        "2014": 127,
        "2015": 155,
        "2016": 131,
        "2017": 92,
        "2018": 67,
        "2019": 68,
        "2020": 56,
        "2021": 44,
        "2022": 44,
        "2023": 38,
        "2024": 49,
        "2025": 42,
      },
    },
    {
      id: 122487,
      artist: "Robbie Williams",
      title: "Angels",
      positions: {
        "2001": 364,
        "2002": 114,
        "2003": 24,
        "2004": 44,
        "2005": 11,
        "2006": 18,
        "2007": 39,
        "2008": 24,
        "2009": 34,
        "2010": 37,
        "2011": 55,
        "2012": 41,
        "2013": 40,
        "2014": 75,
        "2015": 80,
        "2016": 74,
        "2017": 68,
        "2018": 76,
        "2019": 89,
        "2020": 82,
        "2021": 92,
        "2022": 90,
        "2023": 59,
        "2024": 70,
        "2025": 86,
      },
    },
    {
      id: 124745,
      artist: "Procol Harum",
      title: "A Whiter Shade\nOf Pale",
      positions: {
        "1999": 10,
        "2000": 18,
        "2001": 23,
        "2002": 20,
        "2003": 22,
        "2004": 28,
        "2005": 22,
        "2006": 25,
        "2007": 47,
        "2008": 26,
        "2009": 50,
        "2010": 42,
        "2011": 65,
        "2012": 61,
        "2013": 83,
        "2014": 98,
        "2015": 105,
        "2016": 119,
        "2017": 117,
        "2018": 153,
        "2019": 162,
        "2020": 153,
        "2021": 3,
        "2022": 64,
        "2023": 42,
        "2024": 113,
        "2025": 143,
      },
    },
    {
      id: 117078,
      artist: "David Bowie",
      title: "Heroes (Albumversie)",
      positions: {
        "1999": 70,
        "2000": 62,
        "2001": 77,
        "2002": 63,
        "2003": 71,
        "2004": 99,
        "2005": 137,
        "2006": 125,
        "2007": 130,
        "2008": 112,
        "2009": 123,
        "2010": 112,
        "2011": 145,
        "2012": 119,
        "2013": 79,
        "2014": 34,
        "2015": 60,
        "2016": 7,
        "2017": 11,
        "2018": 17,
        "2019": 27,
        "2020": 10,
        "2021": 24,
        "2022": 26,
        "2023": 24,
        "2024": 31,
        "2025": 40,
      },
    },
    {
      id: 79647,
      artist: "Coldplay",
      title: "Fix You",
      positions: {
        "2009": 1494,
        "2010": 235,
        "2011": 69,
        "2012": 40,
        "2013": 20,
        "2014": 15,
        "2015": 10,
        "2016": 11,
        "2017": 8,
        "2018": 9,
        "2019": 8,
        "2020": 8,
        "2021": 11,
        "2022": 5,
        "2023": 5,
        "2024": 2,
        "2025": 4,
      },
    },
    {
      id: 342538,
      artist: "Billy Joel",
      title: "Goodnight Saigon",
      positions: {
        "1999": 14,
        "2000": 11,
        "2001": 8,
        "2002": 18,
        "2003": 25,
        "2004": 22,
        "2005": 34,
        "2006": 51,
        "2007": 38,
        "2008": 32,
        "2009": 53,
        "2010": 38,
        "2011": 62,
        "2012": 80,
        "2013": 90,
        "2014": 83,
        "2015": 79,
        "2016": 77,
        "2017": 81,
        "2018": 93,
        "2019": 101,
        "2020": 117,
        "2021": 110,
        "2022": 133,
        "2023": 157,
        "2024": 173,
        "2025": 210,
      },
    },
    {
      id: 2236,
      artist: "The Beatles",
      title: "Yesterday",
      positions: {
        "1999": 6,
        "2000": 8,
        "2001": 24,
        "2002": 30,
        "2003": 34,
        "2004": 37,
        "2005": 46,
        "2006": 39,
        "2007": 32,
        "2008": 28,
        "2009": 44,
        "2010": 33,
        "2011": 50,
        "2012": 85,
        "2013": 76,
        "2014": 89,
        "2015": 96,
        "2016": 97,
        "2017": 87,
        "2018": 122,
        "2019": 94,
        "2020": 104,
        "2021": 120,
        "2022": 135,
        "2023": 158,
        "2024": 131,
        "2025": 208,
      },
    },
    {
      id: 118945,
      artist: "Prince & The Revolution",
      title: "Purple Rain (Albumversie)",
      positions: {
        "1999": 54,
        "2000": 90,
        "2001": 160,
        "2002": 120,
        "2003": 160,
        "2004": 104,
        "2005": 152,
        "2006": 126,
        "2007": 148,
        "2008": 132,
        "2009": 169,
        "2010": 79,
        "2011": 80,
        "2012": 74,
        "2013": 77,
        "2014": 71,
        "2015": 62,
        "2016": 13,
        "2017": 18,
        "2018": 25,
        "2019": 24,
        "2020": 13,
        "2021": 21,
        "2022": 21,
        "2023": 19,
        "2024": 29,
        "2025": 34,
      },
    },
    {
      id: 61289,
      artist: "Adele",
      title: "Rolling In The Deep",
      positions: {
        "2011": 21,
        "2012": 13,
        "2013": 75,
        "2014": 88,
        "2015": 75,
        "2016": 101,
        "2017": 163,
        "2018": 163,
        "2019": 159,
        "2020": 209,
        "2021": 145,
        "2022": 241,
        "2023": 203,
        "2024": 196,
        "2025": 258,
      },
    },
    {
      id: 111652,
      artist: "The Moody Blues",
      title: "Nights In White Satin",
      positions: {
        "1999": 15,
        "2000": 25,
        "2001": 29,
        "2002": 23,
        "2003": 28,
        "2004": 33,
        "2005": 35,
        "2006": 23,
        "2007": 50,
        "2008": 31,
        "2009": 42,
        "2010": 41,
        "2011": 45,
        "2012": 65,
        "2013": 68,
        "2014": 76,
        "2015": 102,
        "2016": 122,
        "2017": 124,
        "2018": 111,
        "2019": 128,
        "2020": 145,
        "2021": 129,
        "2022": 159,
        "2023": 155,
        "2024": 164,
        "2025": 177,
      },
    },
    {
      id: 65489,
      artist: "Pink Floyd",
      title: "Comfortably\nNumb (Albumversie)",
      positions: {
        "2000": 74,
        "2002": 1356,
        "2003": 358,
        "2004": 53,
        "2005": 25,
        "2006": 19,
        "2007": 17,
        "2008": 34,
        "2009": 15,
        "2010": 13,
        "2011": 12,
        "2012": 10,
        "2013": 8,
        "2014": 8,
        "2015": 11,
        "2016": 16,
        "2017": 12,
        "2018": 14,
        "2019": 16,
        "2020": 19,
        "2021": 22,
        "2022": 13,
        "2023": 14,
        "2024": 15,
        "2025": 15,
      },
    },
    {
      id: 64232,
      artist: "R.E.M.",
      title: "Losing My Religion",
      positions: {
        "1999": 25,
        "2000": 15,
        "2001": 37,
        "2002": 42,
        "2003": 33,
        "2004": 46,
        "2005": 76,
        "2006": 79,
        "2007": 132,
        "2008": 60,
        "2009": 67,
        "2010": 83,
        "2011": 68,
        "2012": 118,
        "2013": 111,
        "2014": 126,
        "2015": 112,
        "2016": 80,
        "2017": 73,
        "2018": 84,
        "2019": 112,
        "2020": 102,
        "2021": 103,
        "2022": 110,
        "2023": 124,
        "2024": 126,
        "2025": 125,
      },
    },
    {
      id: 138954,
      artist: "U2",
      title: "One",
      positions: {
        "2001": 689,
        "2002": 766,
        "2003": 82,
        "2004": 14,
        "2005": 17,
        "2006": 6,
        "2007": 8,
        "2008": 10,
        "2009": 14,
        "2010": 14,
        "2011": 13,
        "2012": 17,
        "2013": 19,
        "2014": 22,
        "2015": 24,
        "2016": 31,
        "2017": 32,
        "2018": 50,
        "2019": 57,
        "2020": 67,
        "2021": 74,
        "2022": 94,
        "2023": 100,
        "2024": 85,
        "2025": 96,
      },
    },
    {
      id: 291696,
      artist: "AC/DC",
      title: "Thunderstruck",
      positions: {
        "2009": 1086,
        "2010": 882,
        "2011": 61,
        "2012": 48,
        "2013": 54,
        "2014": 24,
        "2015": 27,
        "2016": 21,
        "2017": 13,
        "2018": 19,
        "2019": 20,
        "2020": 24,
        "2021": 31,
        "2022": 28,
        "2023": 28,
        "2024": 30,
        "2025": 30,
      },
    },
    {
      id: 68146,
      artist: "Adele",
      title: "Make You Feel My Love",
      positions: {
        "2009": 28,
        "2010": 12,
        "2011": 19,
        "2012": 23,
        "2013": 53,
        "2014": 61,
        "2015": 33,
        "2016": 84,
        "2017": 138,
        "2018": 144,
        "2019": 177,
        "2020": 227,
        "2021": 191,
        "2022": 348,
        "2023": 387,
        "2024": 337,
        "2025": 421,
      },
    },
    {
      id: 1062665,
      artist: "Claudia de Breij",
      title: "Mag Ik Dan Bij Jou",
      positions: {
        "2012": 1565,
        "2013": 472,
        "2014": 19,
        "2015": 4,
        "2016": 8,
        "2017": 14,
        "2018": 24,
        "2019": 38,
        "2020": 54,
        "2021": 86,
        "2022": 109,
        "2023": 131,
        "2024": 145,
        "2025": 152,
      },
    },
    {
      id: 819848,
      artist: "The Amazing Stroopwafels",
      title: "Oude Maasweg",
      positions: {
        "1999": 191,
        "2000": 112,
        "2001": 46,
        "2002": 44,
        "2003": 49,
        "2004": 69,
        "2005": 26,
        "2006": 38,
        "2007": 16,
        "2008": 29,
        "2009": 66,
        "2010": 49,
        "2011": 81,
        "2012": 103,
        "2013": 108,
        "2014": 125,
        "2015": 149,
        "2016": 146,
        "2017": 153,
        "2018": 217,
        "2019": 199,
        "2020": 231,
        "2021": 223,
        "2022": 225,
        "2023": 244,
        "2024": 195,
        "2025": 189,
      },
    },
    {
      id: 415424,
      artist: "John Miles",
      title: "Music",
      positions: {
        "1999": 19,
        "2000": 39,
        "2001": 32,
        "2002": 37,
        "2003": 36,
        "2004": 67,
        "2005": 75,
        "2006": 65,
        "2007": 76,
        "2008": 56,
        "2009": 111,
        "2010": 122,
        "2011": 123,
        "2012": 113,
        "2013": 129,
        "2014": 116,
        "2015": 135,
        "2016": 170,
        "2017": 187,
        "2018": 209,
        "2019": 205,
        "2020": 236,
        "2021": 236,
        "2022": 206,
        "2023": 191,
        "2024": 213,
        "2025": 209,
      },
    },
    {
      id: 2087386,
      artist: "Normaal",
      title: "De Boer Dat Is\nDe Keerl",
      positions: {
        "2019": 9,
        "2020": 193,
        "2021": 464,
        "2022": 481,
        "2023": 916,
        "2024": 1223,
        "2025": 1179,
      },
    },
    {
      id: 53753,
      artist: "Coldplay",
      title: "Clocks",
      positions: {
        "2003": 733,
        "2004": 10,
        "2005": 7,
        "2006": 9,
        "2007": 6,
        "2008": 11,
        "2009": 8,
        "2010": 8,
        "2011": 8,
        "2012": 9,
        "2013": 12,
        "2014": 20,
        "2015": 29,
        "2016": 36,
        "2017": 46,
        "2018": 57,
        "2019": 80,
        "2020": 96,
        "2021": 116,
        "2022": 1777,
        "2023": 1754,
        "2024": 67,
        "2025": 91,
      },
    },
    {
      id: 1708241,
      artist: "Ramses Shaffy",
      title: "Laat Me",
      positions: {
        "1999": 796,
        "2000": 591,
        "2001": 579,
        "2002": 398,
        "2003": 452,
        "2004": 310,
        "2005": 138,
        "2006": 175,
        "2007": 264,
        "2008": 213,
        "2009": 10,
        "2010": 48,
        "2011": 93,
        "2012": 153,
        "2013": 134,
        "2014": 131,
        "2015": 122,
        "2016": 126,
        "2017": 108,
        "2018": 161,
        "2019": 93,
        "2020": 97,
        "2021": 117,
        "2022": 147,
        "2023": 167,
        "2024": 182,
        "2025": 101,
      },
    },
    {
      id: 1301530,
      artist: "Ramses Shaffy",
      title: "Zing, Vecht, Huil,\nBid, Lach, Werk\nEn Bewonder",
      positions: {
        "1999": 297,
        "2000": 584,
        "2001": 548,
        "2002": 304,
        "2003": 295,
        "2004": 235,
        "2005": 161,
        "2006": 164,
        "2007": 267,
        "2008": 202,
        "2009": 7,
        "2010": 65,
        "2011": 85,
        "2012": 150,
        "2013": 140,
        "2014": 172,
        "2015": 166,
        "2016": 163,
        "2017": 199,
        "2018": 250,
        "2019": 167,
        "2020": 183,
        "2021": 212,
        "2022": 319,
        "2023": 202,
        "2024": 320,
        "2025": 319,
      },
    },
    {
      id: 9153169,
      artist: "Alice Cooper",
      title: "Halo Of Flies",
      positions: {
        "1999": 63,
        "2000": 24,
        "2001": 19,
        "2002": 21,
        "2003": 35,
        "2004": 39,
        "2005": 57,
        "2006": 78,
        "2007": 56,
        "2008": 51,
        "2009": 91,
        "2010": 85,
        "2011": 109,
        "2012": 167,
        "2013": 191,
        "2014": 209,
        "2015": 253,
        "2016": 288,
        "2017": 268,
        "2018": 452,
        "2019": 535,
        "2020": 662,
        "2021": 651,
        "2022": 637,
        "2023": 654,
        "2024": 620,
        "2025": 700,
      },
    },
    {
      id: 1470855,
      artist: "Marco Borsato",
      title: "Rood",
      positions: {
        "2006": 17,
        "2007": 30,
        "2008": 73,
        "2009": 79,
        "2010": 133,
        "2011": 187,
        "2012": 263,
        "2013": 342,
        "2014": 374,
        "2015": 323,
        "2016": 527,
        "2017": 653,
        "2018": 544,
        "2019": 498,
        "2020": 790,
        "2021": 1005,
        "2022": 1456,
        "2023": 1077,
        "2024": 989,
        "2025": 53,
      },
    },
  ];

  let allYears = $derived.by(() => {
    const yearsSet = new Set<number>();
    rawData.forEach((s) =>
      Object.keys(s.positions).forEach((y) => yearsSet.add(parseInt(y)))
    );
    return Array.from(yearsSet).sort((a, b) => a - b);
  });

  let width = $derived(
    CONFIG.margins.left +
      CONFIG.margins.right +
      (allYears.length - 1) * CONFIG.colWidth
  );
  let height = $derived(
    CONFIG.margins.top +
      CONFIG.margins.bottom +
      (CONFIG.topN - 1) * CONFIG.rowHeight
  );

  const PALETTE = [
    "#e2001a", // 01 Red (Fixed)
    "#00d9ff", // 02 Cyan
    "#ffeb3b", // 03 Bright Yellow
    "#b24bf3", // 04 Vivid Purple
    "#00ff88", // 05 Spring Green
    "#ff2e97", // 06 Hot Pink
    "#ff8c00", // 07 Dark Orange
    "#ffffff", // 08 White (Pure contrast)
    "#00ffcc", // 09 Aqua Mint
    "#ef4444", // 32 Red Bright

    // ── 11-40: High Saturation & Brightness ──
    "#ff4757", // 11 Coral Red
    "#18ffff", // 12 Electric Cyan
    "#ffd93d", // 13 Golden Yellow
    "#7c3aed", // 14 Deep Violet
    "#4da6ff", // 15 Sky Blue
    "#fb923c", // 16 Tangerine
    "#0ea5e9", // 17 Ocean Blue
    "#4ade80", // 18 Lime
    "#2dd4bf", // 19 Teal
    "#c084fc", // 20 Lavender
    "#ff5555", // 21 Light Red
    "#06b6d4", // 22 Cyan Blue
    "#10b981", // 23 Emerald
    "#d946ef", // 24 Magenta
    "#f472b6", // 25 Fuchsia
    "#fbbf24", // 26 Amber
    "#3b82f6", // 27 Royal Blue
    "#f97316", // 28 Orange
    "#a855f7", // 29 Violet
    "#14b8a6", // 30 Teal Green
    "#8b5cf6", // 31 Purple Mid
    "#facc15", // 33 Yellow Gold
    "#9d5cff", // 10 Medium Purple
    "#22d3ee", // 34 Sky Cyan
    "#34d399", // 35 Mint Green
    "#ec4899", // 36 Pink Bright
    "#60a5fa", // 37 Blue Light
    "#f59e0b", // 38 Amber Orange
    "#5eead4", // 39 Turquoise
    "#e879f9", // 40 Orchid

    // ── 41-70: Variance in Tints and Neon Pops ──
    "#ff1493", // 41 Deep Pink
    "#00ced1", // 42 Dark Turquoise
    "#adff2f", // 43 Green Yellow
    "#ff4500", // 44 Orange Red
    "#da70d6", // 45 Orchid
    "#00fa9a", // 46 Medium Spring Green
    "#1e90ff", // 47 Dodger Blue
    "#ff00ff", // 48 Magenta/Fuchsia
    "#7fff00", // 49 Chartreuse
    "#ff7f50", // 50 Coral
    "#9370db", // 51 Medium Purple
    "#00ff00", // 52 Lime (Pure)
    "#ff6347", // 53 Tomato
    "#40e0d0", // 54 Turquoise
    "#ee82ee", // 55 Violet
    "#f0e68c", // 56 Khaki/Light Yellow
    "#87cefa", // 57 Light Sky Blue
    "#32cd32", // 58 Lime Green
    "#ff69b4", // 59 Hot Pink Light
    "#00bfff", // 60 Deep Sky Blue
    "#ffa07a", // 61 Light Salmon
    "#ba55d3", // 62 Medium Orchid
    "#00ff7f", // 63 Spring Green
    "#ffff00", // 64 Yellow (Pure)
    "#ffb6c1", // 65 Light Pink
    "#4682b4", // 66 Steel Blue
    "#7fffd4", // 67 Aquamarine
    "#ffdead", // 68 Navajo White
    "#98fb98", // 69 Pale Green
    "#afeeee", // 70 Pale Turquoise
  ];

  let songColorMap = $derived.by(() => {
    const songsIn2025 = rawData
      .filter((song) => song.positions[2025] !== undefined)
      .map((song) => ({
        id: song.id,
        rank2025: song.positions[2025],
      }))
      .sort((a, b) => a.rank2025 - b.rank2025);

    const colorMap = new Map<number, string>();
    songsIn2025.forEach((song, index) => {
      colorMap.set(song.id, PALETTE[index % PALETTE.length]);
    });
    return colorMap;
  });

  function getSongColor(songId: number): string {
    return songColorMap.get(songId) || PALETTE[0];
  }

  function getX(yearIndex: number) {
    return CONFIG.margins.left + yearIndex * CONFIG.colWidth;
  }
  function getY(rank: number) {
    return CONFIG.margins.top + (rank - 1) * CONFIG.rowHeight;
  }

  let segments = $derived.by(() => {
    const result: Segment[] = [];

    rawData.forEach((song) => {
      const activeYears = Object.entries(song.positions)
        .map(([y, r]) => ({ year: parseInt(y), rank: r }))
        .filter((p) => p.rank <= CONFIG.topN && allYears.includes(p.year))
        .sort((a, b) => a.year - b.year);

      if (activeYears.length === 0) return;

      let currentSegment: Point[] = [];

      for (let i = 0; i < activeYears.length; i++) {
        const curr = activeYears[i];
        const yearIndex = allYears.indexOf(curr.year);

        if (yearIndex === -1) continue;

        const x = getX(yearIndex);
        const y = getY(curr.rank);

        const isGap = i > 0 && curr.year - activeYears[i - 1].year > 1;

        if (isGap) {
          if (currentSegment.length > 0) {
            currentSegment[currentSegment.length - 1].type = "gap-start";
            result.push({
              points: currentSegment,
              color: getSongColor(song.id),
              song,
              isFinal: false,
            });
          }
          currentSegment = [];
        }

        let type: Point["type"] = "continuous";

        if (currentSegment.length === 0) {
          type = i === 0 ? "start" : "gap-end";
        }

        currentSegment.push({ year: curr.year, rank: curr.rank, x, y, type });
      }

      if (currentSegment.length > 0) {
        currentSegment[currentSegment.length - 1].type = "end";
        const finalRank = song.positions[2025];
        result.push({
          points: currentSegment,
          color: getSongColor(song.id),
          song,
          isFinal: true,
          finalRank,
        });
      }
    });

    result.sort((a, b) => {
      const rankA = a.finalRank ?? 999;
      const rankB = b.finalRank ?? 999;
      return rankB - rankA;
    });

    return result;
  });

  function generatePath(points: Point[]): string {
    if (points.length === 0) return "";
    let d = `M ${points[0].x} ${points[0].y}`;

    for (let i = 0; i < points.length - 1; i++) {
      const p1 = points[i];
      const p2 = points[i + 1];

      // Bezier Control Points
      // curvature controls how "steep" the curve is.
      const curvature = 0.5;
      const cp1x = p1.x + (p2.x - p1.x) * curvature;
      const cp1y = p1.y;
      const cp2x = p2.x - (p2.x - p1.x) * curvature;
      const cp2y = p2.y;

      d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
    }
    return d;
  }

  let svgRef: SVGElement | undefined = $state();

  function downloadSVG() {
    if (!svgRef) return;

    // Serializing the SVG DOM to a string
    const serializer = new XMLSerializer();
    let source = serializer.serializeToString(svgRef);

    // Add XML declaration
    source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

    // Convert to Blob and trigger download
    const url =
      "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
    const link = document.createElement("a");
    link.href = url;
    link.download = "top2000-chart.svg";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

<div class="p-4">
  <div class="mb-4">
    <Button onclick={downloadSVG}>Download SVG</Button>
  </div>

  <div class="overflow-auto border border-slate-300 shadow-xl inline-block">
    <svg
      bind:this={svgRef}
      {width}
      {height}
      viewBox="0 0 {width} {height}"
      xmlns="http://www.w3.org/2000/svg"
    >
      <defs>
        <style type="text/css">
          /* @import url("https://fonts.cdnfonts.com/css/caros-soft");
          @import url("https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap"); */

          .font-sans {
            font-family: "DM Sans", sans-serif;
          }
          .font-header {
            font-family: "Caros Soft", sans-serif;
          }
          .bg-fill {
            fill: #0f172a;
          }
        </style>
      </defs>

      <rect {width} {height} class="bg-fill" />

      <g transform="translate({CONFIG.margins.left}, 50)">
        <g transform="translate(-5, 0)">
          <text
            x="-2"
            y="10"
            fill="white"
            class="font-header"
            font-weight="bold"
            letter-spacing="-0.025em"
            style="font-size: 36px;"
          >
            <tspan fill="#e2001a">Top2000</tspan> • Door de jaren heen
          </text>
          <text
            x="0"
            y="36"
            fill="#94a3b8"
            class="font-sans"
            font-weight="500"
            style="font-size: 18px;"
          >
            De beste {CONFIG.topN}
            nummers van {allYears[0]} tot {allYears[allYears.length - 1]}
          </text>
        </g>

        <!-- <g transform="translate(-5, 60)">
          <circle
            r="4"
            fill="none"
            stroke="#64748b"
            stroke-width="2"
            cx="5"
            cy="-5"
          />
          <text
            x="15"
            y="0"
            fill="#64748b"
            class="font-sans"
            font-style="italic"
            style="font-size: 12px;"
          >
            Open cirkels duiden op een tijdelijke val uit de top {CONFIG.topN}
          </text>
        </g> -->
      </g>

      {@render GridLines()}

      <g class="chart-lines">
        {#each segments as segment}
          {@render SongLine(segment)}
        {/each}
      </g>

      <g class="chart-nodes">
        {#each segments as segment}
          {@render SongNodes(segment)}
        {/each}
      </g>

      <g class="chart-labels">
        {#each segments as segment}
          {#if segment.isFinal}
            {@render Label(
              segment,
              segment.points[segment.points.length - 1].year === 2025
            )}
          {:else}
            {@render Label(segment, false)}
          {/if}
        {/each}
      </g>

      <g
        transform="translate({width - CONFIG.margins.right + 15}, {height -
          40})"
      >
        <text
          x="0"
          y="0"
          class="font-sans"
          style="font-size: 12px; fill: #94a3b8; font-weight: 500;"
        >
          Data: NPO Radio 2 Top 2000
        </text>
        <text
          x="0"
          y="18"
          class="font-sans"
          style="font-size: 11px; fill: #64748b;"
        >
          Gemaakt door Bram Leisink • {new Date().getFullYear()}
        </text>
      </g>
    </svg>
  </div>
</div>

{#snippet GridLines()}
  <g>
    {#each allYears as year, i}
      {@const x = getX(i)}
      <line
        opacity={0.2}
        x1={x}
        y1={CONFIG.margins.top}
        x2={x}
        y2={height - CONFIG.margins.bottom}
        stroke="white"
        stroke-dasharray="4 4"
        stroke-width="1"
      />
      <text
        {x}
        y={CONFIG.margins.top - 20}
        text-anchor="middle"
        class="font-sans"
        font-weight="bold"
        fill="#64748b"
        style="font-size: 14px;"
      >
        {year}
      </text>
    {/each}
    {#each { length: CONFIG.topN } as _, i}
      {@const y = getY(i + 1)}
      <text
        x={CONFIG.margins.left - 25}
        y={y + 6}
        text-anchor="end"
        class="font-sans"
        font-weight="bold"
        fill="#64748b"
        style="font-size: 15px;"
      >
        #{i + 1}
      </text>
    {/each}
  </g>
{/snippet}

{#snippet SongLine(segment: Segment)}
  <path
    d={generatePath(segment.points)}
    fill="none"
    stroke="#0f172a"
    stroke-width="8"
    stroke-linecap="round"
    stroke-linejoin="round"
  />
  <path
    d={generatePath(segment.points)}
    fill="none"
    stroke={segment.color}
    stroke-width="4"
    stroke-linecap="round"
    stroke-linejoin="round"
  />
{/snippet}

{#snippet SongNodes(segment: Segment)}
  {#each segment.points as point}
    <g transform="translate({point.x}, {point.y})">
      <circle
        r={CONFIG.nodeRadius}
        fill={segment.color}
        stroke="#0f172a"
        stroke-width="2"
      >
        <title>{segment.song.title} ({point.year}: #{point.rank})</title>
      </circle>
      {#if point.type === "gap-start" || point.type === "gap-end"}
        <circle r={CONFIG.nodeRadius - 2} fill="#0f172a" />
      {/if}
      <!-- <circle r="12" fill="transparent">
        <title>{segment.song.title} ({point.year}: #{point.rank})</title>
      </circle> -->
    </g>
  {/each}
{/snippet}

{#snippet Label(segment: Segment, final?: boolean, small?: boolean)}
  {@const lastPoint = segment.points[segment.points.length - 1]}
  {@const cleanTitle = segment.song.title.replace("(Albumversie)", "").trim()}
  {@const titleLines = cleanTitle.split("\n")}
  {@const artistLines = segment.song.artist.split("\n")}

  {#if final}
    <g transform="translate({lastPoint.x + 15}, {lastPoint.y + 5})">
      <text
        class="font-sans"
        font-weight="bold"
        fill="white"
        style="font-size: 14px;"
      >
        {titleLines.join(" ")}
      </text>
      <text y="14" class="font-sans" fill="#94a3b8" style="font-size: 12px;">
        {artistLines.join(" ")}
      </text>
    </g>
  {:else if small}
    <g transform="translate({lastPoint.x + 12}, {lastPoint.y - 10})">
      <text
        y="14"
        class="font-sans"
        fill="#475569"
        font-style="italic"
        style="font-size: 12px;"
      >
        {cleanTitle.length > 15
          ? cleanTitle.slice(0, cleanTitle.lastIndexOf(" ", 15)) + "…"
          : cleanTitle}
      </text>
    </g>
  {:else}
    <g transform="translate({lastPoint.x + 12}, {lastPoint.y + 4})">
      {#each titleLines as line, i}
        <text
          y={i * 15}
          class="font-sans"
          font-weight="bold"
          fill="white"
          letter-spacing="-0.025em"
          style="font-size: 12px;"
        >
          {line}
        </text>
      {/each}
      {#each artistLines as line, i}
        <text
          y={titleLines.length * 15 + i * 14}
          class="font-sans"
          fill="#94a3b8"
          letter-spacing="-0.05em"
          style="font-size: 12px;"
        >
          {line}
        </text>
      {/each}
    </g>
  {/if}
{/snippet}
